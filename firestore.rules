/**
 * This ruleset defines the security model for the "Smart Study MPSE" application.
 *
 * Core Philosophy:
 * The security model is based on a strict Role-Based Access Control (RBAC) system.
 * There are two primary roles: "Student" (a standard user) and "Admin".
 * Admin privileges are granted by the existence of a corresponding document in the `/roles_admin`
 * collection, providing a secure and verifiable way to manage administrative access.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user profile data. Each user can only access their own document.
 * - /roles_admin/{userId}: A private collection used as a lookup table to grant admin rights.
 * - /papers/{paperId}: A public collection of subjects or papers, readable by anyone.
 * - /papers/{paperId}/pdfDocuments/{pdfDocumentId}: A public subcollection of PDF documents, readable by anyone.
 *
 * Key Security Decisions:
 * - Admin-Only Content Management: All creation, modification, and deletion of public content
 *   (Papers and PdfDocuments) is restricted to users with the Admin role.
 * - Strict User Data Privacy: A user's profile data in `/users/{userId}` is private. It can only
 *   be created, read, and modified by the user themselves. The full list of users is not queryable.
 * - Public Read Access: All educational content (`papers` and `pdfDocuments`) is publicly readable
 *   to allow any visitor or user to browse the application's offerings without being signed in.
 * - Default Deny: Access is denied by default. All permissions must be explicitly granted.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the requesting user has administrative privileges.
     * Admin status is granted if a document with the user's UID exists
     * in the private `/roles_admin` collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Ensures that a document being updated or deleted actually exists.
     * Prevents writes to non-existent paths.
     */
    function documentExists() {
      return resource != null;
    }

    // --------------------------------------------------------------------
    // User Profiles (/users/{userId})
    // --------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document.
     * @deny (list) Any user, including admins, attempting to list all user profiles.
     * @principle Restricts access to a user's own data tree, enforcing privacy.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && documentExists() && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && documentExists();
    }

    // --------------------------------------------------------------------
    // Admin Roles (/roles_admin/{userId})
    // --------------------------------------------------------------------

    /**
     * @description Manages admin role grants. This collection is write-only for admins and not readable.
     * @path /roles_admin/{userId}
     * @allow (create) An existing admin granting admin rights to another user.
     * @deny (get) Any user attempting to read an admin role document directly.
     * @principle Secures the admin-granting mechanism itself. Rules rely on `exists()` not `get()`.
     */
    match /roles_admin/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin() && documentExists();
    }

    // --------------------------------------------------------------------
    // Papers (/papers/{paperId})
    // --------------------------------------------------------------------

    /**
     * @description Manages paper/subject documents. Readable by anyone, writable only by admins.
     * @path /papers/{paperId}
     * @allow (get, list) Any user (anonymous or signed-in) reading paper information.
     * @deny (create) A non-admin user attempting to create a new paper.
     * @principle Provides public read access for content while securing writes to admins.
     */
    match /papers/{paperId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && documentExists();
      allow delete: if isAdmin() && documentExists();
    }

    // --------------------------------------------------------------------
    // PDF Documents (/papers/{paperId}/pdfDocuments/{pdfDocumentId})
    // --------------------------------------------------------------------

    /**
     * @description Manages PDF documents nested under a specific paper.
     * @path /papers/{paperId}/pdfDocuments/{pdfDocumentId}
     * @allow (list) Any user (anonymous or signed-in) listing PDFs for a given paper.
     * @deny (update) A non-admin user attempting to change a PDF link.
     * @principle Enforces relational integrity and admin-only writes for nested content.
     */
    match /papers/{paperId}/pdfDocuments/{pdfDocumentId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin() && request.resource.data.paperId == paperId;
      allow update: if isAdmin() && documentExists() && request.resource.data.paperId == resource.data.paperId;
      allow delete: if isAdmin() && documentExists();
    }
  }
}